#!/bin/sh
#LANG=zh_CN.UTF-8

# 关闭crontab
service crond stop
systemctl stop crond

# 写hosts, 屏蔽病毒脚本下载
busybox echo -e "\n0.0.0.0 pastebin.com\n0.0.0.0 thyrsi.com" >> /etc/hosts

# 删除，创建，并锁定 crontab相关文件
busybox rm -rf /var/spool/cron/root && busybox touch /var/spool/cron/root && busybox chattr +i  /var/spool/cron/root
busybox rm -rf /var/spool/cron/crontabs/root && busybox touch /var/spool/cron/crontabs/root && busybox chattr +i /var/spool/cron/crontabs/root 
busybox rm -rf /etc/cron.d/root && busybox touch /etc/cron.d/root && busybox chattr +i /etc/cron.d/root

# 删除cron.d目录的其他文件
#busybox rm -rf /etc/cron.d/*

# 删除病毒相关执行文件和启动脚
busybox find / -type f -name '*watchdogs*'|busybox xargs rm -f

# 删除病毒进程
busybox pkill watchdogs
busybox pkill ksoftirqds

# 删除被preload的so库
chattr -i /etc/ld.so.preload
chattr -i /usr/local/lib/libioset.so
busybox rm -rf /usr/local/lib/libioset.so
busybox rm -rf /etc/ld.so.preload
busybox rm -rf /etc/ld.so.cache

# 验证libioset.so被卸载
# lsof |grep /usr/local/lib/libioset.so
# 无输出, 则该动态链接库被卸载, 直接执行验证步骤; 有输出, kill掉占用的进程, ,重复执行该步骤;


# 再次清理异常进程
busybox ps -ef | busybox grep -v grep | busybox egrep 'ksoftirqds' | busybox awk '{print $1}' | busybox xargs kill -9
busybox ps -ef | busybox grep -v grep | busybox egrep 'watchdogs' | busybox awk '{print $1}' | busybox xargs kill -9

# 清理异常文件
busybox rm -rf /tmp/watchdogs
busybox rm -rf /etc/cron.d/tomcat
busybox rm -rf /etc/cron.d/root
busybox rm -rf /var/spool/cron/root
busybox rm -rf /var/spool/cron/crontabs/root
busybox rm -rf /etc/rc.d/init.d/watchdogs
busybox rm -rf /usr/sbin/watchdogs
busybox rm -rf /tmp/config.json
busybox rm -rf /tmp/ksoftirqds
busybox rm -rf /tmp/.lsdpid

# 修改动态链接库之后需要用执行动态库执行命令
ldconfig

# 清理开机启动项
chkconfig watchdogs off
chkconfig --del watchdogs

service crond start
echo "Done, Please reboot!"
